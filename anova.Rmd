---
title: "Pressuposi√ß√µes da ANOVA"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{css, echo = FALSE}
body {
     text-align: justify;
}

```

# Fundamentos

Quais s√£o as pressuposi√ß√µes para a realiza√ß√£o da An√°lise de Vari√¢ncia?

* Os erros devem seguir uma distribui√ß√£o normal;
* Os erros devem ser independentes;
* Os erros devem apresentar vari√¢ncia constante, ou seja, homogeneidade de vari√¢ncias;
* O modelo deve ser aditivo


# Exemplo

|      Um pesquisador pretende comparar quatro variedades de p√™ssego quanto ao enraizamento de estacas. Para tanto, realizou um experimento de acordo com o delineamento inteiramente casualizado com cinco repeti√ß√µes, sendo cada parcela um vaso com vinte estacas. Passado o tempo necess√°rio, o pesquisador anotou o n√∫mero de estacas enraizadas, apresentado na Tabela a seguir.

Tabela 1: N√∫mero de estacas enraizadas por variedade de p√™ssego.

| Variedades | REP. 1 | REP. 2 | REP. 3 | REP. 4 | REP. 5 | Total | M√©dia | Vari√¢ncia |
|------------|--------|--------|--------|--------|--------|-------|-------|-----------|
| A          | 2      | 2      | 1      | 1      | 0      | 6     | 1,2   | 0,7       |
| B          | 1      | 0      | 0      | 1      | 1      | 3     | 0,6   | 0,3       |
| C          | 12     | 10     | 14     | 17     | 11     | 64    | 12,8  | 7,7       |
| D          | 7      | 9      | 15     | 8      | 10     | 49    | 9,8   | 9,7       |


```{r, echo=FALSE}

dadospessego <- data.frame(Variedadepessego = factor(rep(1:4,
                                                 each = 5)), 
                           estacasenraizadas = c(2, 2, 1, 1, 0,
                                                 1, 0, 0, 1, 1,
                                                 12, 10, 14, 17, 11,
                                                 7, 9, 15, 8, 10))



```



|     Esse experimento seguiu um delineamento inteiramente casualuzado, portanto segue o seguinte modelo:

\begin{equation}
y_{ij} = \mu + \tau_i + e_{ij} = \mu_i + e_{ij} 

\end{equation}


em que:

- $y_{ij}$ √© o valor observado na j-√©sima repeti√ß√£o do i√©simo tratamento, com: 
 - $i = 1, ... , I$ e 
 - $j = 1, ... , n_i$
  
- $\mu$ √© uma constante inerente a todas as observa√ß√µes, geralmente a m√©dia geral,

- $\tau_i$ √© o efeito do i√©simo tratamento,

- $e_{ij}$ √© o erro experimental, tal que $e_{ij} \overset{iid}{\sim}  N(0,\sigma^2)$.

## An√°lise de res√≠duos

Para obter o valor predito do res√≠duo.

\begin{equation}
y_{ij} = \mu_i + e_{ij}  

\end{equation}

$$ e_{ij} = \mu_i - y_{ij} $$ 
Res√≠duos Padronizados ($z_{ij}$) e Res√≠duos estudentizados ($d_{ij}$)

Observa√ß√µes discrepantes e aparente
homogeneidade/heterogeneidade de vari√¢ncias.

$$z_{ij} = \displaystyle{\frac{e_{ij}}{\sqrt{\text{QM}_{\text{Res√≠duo}}}}}$$

$$d_{ij} = \displaystyle{\frac{e_{ij}}{\sqrt{(1-1/J)\text{QM}_{\text{Res√≠duo}}}}}$$

## Observa√ß√µes discrepantes (at√≠picas)

Observa√ß√µes discrepantes s√£o valores que se afastam muito do esperado para a vari√°vel.

Avalia√ß√£o gr√°fica:

Alguns poss√≠veis gr√°ficos:

* Res√≠duos estudentizados (ou padronizados) versus Tratamentos
* Gr√°fico de caixas dos res√≠duos estudentizados (ou padronizados)



```{r, echo=FALSE}
library(ggplot2)
ggplot(dadospessego,
       aes(x = Variedadepessego,
           y = estacasenraizadas)) +
  geom_point(position = position_jitter(w = 0.2, h = 0)) +
  theme_bw() +
  ylab("N√∫mero de estacas enraizadas") +
  xlab("Variedade")
```

```{r, echo=FALSE}
modelopessego <- lm(estacasenraizadas ~ Variedadepessego, dadospessego)

(respessego <- residuals(modelopessego)) # res√≠duos simples
(res_Studpessego <- rstandard(modelopessego)) # res√≠duos estudentizados

```


Observa√ß√µes:

* 95% dos res√≠duos devem pertencer ao intervalo (-2,2);

* Valores n√£o pertencentes ao intervalo (-3,3) podem ser classificados como discrepantes;

* N√£o podemos excluir observa√ß√µes discrepantes antes de conversar com o pesquisador, pois pode ter ocorrido algum erro de tabula√ß√£o ou a observa√ß√£o pode indicar uma caracter√≠stica importante associada ao respectivo tratamento;


### boxplot residuos estudentizados

```{r}
boxplot(res_Studpessego
)
```


S√£o observados dois valores discrepantes para os res√≠duos, quando esperada a normalidade dos erros. Logo, n√£o se observa 95% dos res√≠duos entre -2 e 2, entretanto 100% destes est√£o entre -3 e 3.


### gr√°fico de pontos 

Observa-se que os dois valores discrepantes est√£o relacionados √†s
variedades C e D. A dispers√£o dos res√≠duos por tratamento ser√°
discutida posteriormente.

```{r, echo=FALSE}
library(ggplot2)
ggplot(dadospessego,
       aes(x = Variedadepessego,
           y = res_Studpessego)) +
  geom_point(position = position_jitter(w = 0.2, h = 0)) +
  theme_bw() +
  ylab("Res√≠duos studentizados") +
  xlab("Variedade")
```



# Independ√™ncia dos Erros

At√© certo ponto, a independ√™ncia dos erros √© garantida pelo princ√≠pio da casualiza√ß√£o. Entretanto, devemos ‚Äúverific√°-la‚Äù nos casos em que poderiam existir correla√ß√µes entre as observa√ß√µes;

* observa√ß√µes no mesmo indiv√≠duos/parcela ao longo do tempo;

* observa√ß√µes na mesma parcela em profundidades diferentes;

* observa√ß√µes de indiv√≠duos agrupados, como por exemplo cobaias em uma mesma gaiola. 


# Homogeneidade de Vari√¢ncias

* A pressuposi√ß√£o de homogeneidade de vari√¢ncias √© a mais importante a ser atendida.

Gr√°ficos

* Res√≠duos estudentizados versus Tratamentos
* Res√≠duos estudentizados versus Valores preditos (yÀúij)

Testes de hip√≥teses

* Teste de Hartley (F m√°ximo)
* Teste de Levene

grafico pontos homogeneidade 


```{r, echo=FALSE}
library(ggplot2)
ggplot(dadospessego,
       aes(x = Variedadepessego,
           y = res_Studpessego)) +
  geom_point(position = position_jitter(w = 0.2, h = 0)) +
  theme_bw() +
  ylab("Res√≠duos studentizados") +
  xlab("Variedade")
```

Observa-se que as dispers√µes dos res√≠duos estudentizados associados
√†s variedades A e B s√£o menores do que as dispers√µes dos res√≠duos
estudentizados associados √†s variedades C e D, aparentemente.


Gr√°fico dos Res√≠duos versus Valores Preditos

```{r}
ggplot( ,
       aes(x = fitted(modelopessego),
           y = res_Studpessego)) + 
  geom_point() + 
  theme_bw () + 
  geom_hline(yintercept = 0) + 
  ylab("Res√≠duos estudentizados") + 
  xlab("Valores esperados (m√©dias)")

```


## Teste de hip√≥teses: Teste de Hartley

$$H0 : \text{H√° homogeneidade de vari√¢ncias}$$
$$Ha : \text{N√£o h√° homogeneidade de vari√¢ncias}$$

Estat√≠stica do teste:
$$F\text{max} = \frac{S^2_{max}}{S^2_{min}}$$

Rejeita-se H0, ao n√≠vel 100 √ó Œ±% de signific√¢ncia, se Fmax ‚â• Fmaxtab(Œ±,ŒΩ1,ŒΩ2), em que ŒΩ1 √© o n√∫mero de graus de liberdade do numerador e ŒΩ2 √© o n√∫mero de graus de liberdade do denominador da estat√≠stica Fmax .



## Teste de hip√≥teses: Teste de Levene (1960)

$$H0 : \text{H√° homogeneidade de vari√¢ncias}$$
$$Ha : \text{N√£o h√° homogeneidade de vari√¢ncias}$$
Estat√≠stica do teste:

1. Ajusta-se o modelo yij = ¬µ + œÑi + eij = ¬µi + eij e obt√™m-se os valores preditos para os erros, Àúeij .

2. Realiza-se a ANOVA para |Àúeij |, de acordo com o modelo |Àúeij | = ŒΩ + Œ≥i + ij .

3. Em caso de efeito significativo de tratamentos, ao n√≠vel 100 √ó Œ±% de signific√¢ncia, h√° evid√™ncias de heterogeneidade de vari√¢ncias.

```{r}
anova(lm(abs(respessego) ~ Variedadepessego, dadospessego))

```

Como o valor-p = 0,06786 > 0,05 = Œ±, considerando-se o n√≠vel de
5% de signific√¢ncia n√£o rejeitamos H0. Logo, n√£o h√° evid√™ncias para afirmarmos que as vari√¢ncias n√£o s√£o homog√™neas.




# Normalidade dos Erros

Assim como para a verifica√ß√£o da homogeneidade de vari√¢ncias, podem ser utilizados gr√°ficos e testes para a verifica√ß√£o da pressuposi√ß√£o a respeito da normalidade dos erros.

Gr√°ficos: 

* Gr√°fico quantil-quantil
* Half normal plot (hnp) com envelope de simula√ß√£o
* Histograma
* Gr√°fico de caixas

Testes de hip√≥teses:

* Shapiro-Wilk
* Kolmogorov-Smirnov
* Qui-quadrado
* entre outros


## Gr√°fico quantil-quantil

```{r}
qqnorm(res_Studpessego)
qqline(res_Studpessego, col=2)
```

Observa-se o afastamento de dois pontos da reta que passa pelos pontos (Q1esp , Q1obs ) e (Q3esp , Q3obs ). Desse modo, espera-se que os erros n√£o sigam uma distribui√ß√£o normal.

Gr√°fico half normal plot com envelope de simula√ß√£o

Atkinson (1985) prop√¥s a adi√ß√£o de um envelope simulado, a partir dos seguintes passos: 

1. Ajuste um modelo a um conjunto de dados e obtenha d(i), valores absolutos ordenados de uma certa estat√≠stica de diagn√≥stico (res√≠duos, hii, etc.);

2. Simule 19 amostras da vari√°vel resposta usando as estimativas obtidas ap√≥s o ajuste do modelo e os mesmos valores para as vari√°veis explanat√≥rias;

3. Ajuste o modelo a cada uma das 19 amostras e calcule os valores absolutos ordenados da estat√≠stica de diagn√≥stico de  interesse, d‚àój(i), j = 1, . . . , 19, i = 1, . . . , n.

4. Para cada i, calcule a m√©dia, o m√≠nimo e o m√°ximo d‚àój(i)

5. Construa um gr√°fico para as quantidades calculadas no item anterior e d(i) versus zi (quantil esperado).

## Gr√°fico quantil-quantil com envelope simulado

```{r}
library(hnp)
hnp(modelopessego,
    print.on = TRUE)
```

√â aceit√°vel que pelo menos 95% dos pontos perten√ßam ao intervalo
de confian√ßa gerado. Para o exemplo, tem-se 30% destes foram do
intervalo. Assim, √© esperado que os erros n√£o sigam uma
distribui√ß√£onormal.


## Teste de hip√≥teses: Shapiro-Wilk (1965)
$$H0 : \text{Os erros seguem uma distribui√ß√£o normal}$$
$$Ha : \text{Os erros n√£o seguem uma distribui√ß√£o normal}$$

$$ W = \frac{(\sum_{i=1}^n a_iy_{(i)})^2}{\sum_{i=1}^n(y_i-y)^2} $$

em que y(i) representa a i-√©sima estat√≠stica de ordem e os coeficientes ai s√£o pesos √≥timos para o estimador de m√≠nimos quadrados ponderados dos desvios-padr√µes para uma popula√ß√£o normal.

```{r}
shapiro.test(res_Studpessego)
```

Como o valor-p = 0,02209 < 0,05 = Œ±, considerando-se o n√≠vel de 5% de signific√¢ncia, rejeitamos H0. Logo, h√° evid√™ncias para afirmarmos que os erros n√£o seguem uma distribui√ß√£o normal.


# Transforma√ß√£o dos dados

Se alguma pressuposi√ß√£o nao for atendida √© possivel realizar a transforma√ß√£o dos dados. 

Como visto, uma alternativa para os casos em que alguma(s) das pressuposi√ß√µes n√£o √©(s√£o) atendida(s) √© a transforma√ß√£o dos dados. 
Vejamos, agora, poss√≠veis casos para o gr√°fico dos res√≠duos versus os valores preditos yÀúij , como ferramenta para diagn√≥stico preliminar.


## Tranforma√ß√£o Box-Cox (1964)

* y*= logy se $\lambda$=0

* y*= $y^\lambda$ se $\lambda$ $\neq$ 0


$\lambda$|$Transforma√ß√£o$ |
---------|--------------|
$-1$|$ 1/(y+0,5)$
$-0,5$|$1/{\sqrt{(y+0,5)}}$
$0$|$ log(y+0,5)$
$0,5$| $\sqrt{y+0,5}$
$1$|$nenhuma$


Ap√≥s realizar a transforma√ß√£o dos dados, deve-se verificar novamente as pressuposi√ß√µes da an√°lise de vari√¢ncia. Caso sejam atendidas, pode-se prosseguir com a an√°lise, lembrando de realizar a transforma√ß√£o inversa ao final.


```{r}
library(MASS)
boxcox(dadospessego$estacasenraizadas+0.5 ~ dadospessego$Variedadepessego, 
       ylab= "logaritmos da verossimilhan√ßa")
```

Observe que o valor 1 n√£o pertence ao intervalo de confian√ßa a 95% para Œª, por√©m, o valor 0,5 pertence, sendo este o valor indicado de Œª.


### An√°lise dos dados transformados

```{r}
#dadospessego$estacasenraizadast <-  (estacasenraizadas+0.5)^0.5
#modelotransformado <- lm(estacasenraizadast ~ Variedadepessego, dadospessego)
```

#### Normalidade dos erros

```{r}
#qqnorm(rstandard(modelotransformado), xlab= "Quantis da distribui√ß√£o normal", ylab= "Res√≠duos estudentizados")
#qqline(rstandard(modelotransformado), col=2)
```


Com os dados transformados e novo modelo ajustado, tem-se que 95% dos res√≠duos encontram-se entre -2 e 2 e, os pontos n√£o apresentam grande afastamento da reta, o que indica poss√≠vel normalidade dos erros.


```{r}
library(hnp)
#hnp(modelotransformado, print.on = TRUE)
```


Com os dados transformados e novo modelo ajustado, tem-se que a maioria dos pontos pertencem ao envelope simulado, indicando poss√≠vel normalidade dos erros. 


```{r}
#shapiro.test(rstandard(modelotransformado))
```


Como o valor-p = 0,8943 > 0,05 = Œ±, considerando-se o n√≠vel de 5% de signific√¢ncia, n√£o rejeitamos H0. Logo, h√° evid√™ncias para afirmarmos que os erros seguem uma distribui√ß√£o normal.

#### Homogeneidade de Vari√¢ncias

```{r}
#ggplot(dadospessego,
  #      aes(x = Variedadepessego,
  #          y = rstandard(modelotransformado))) + 
  # geom_point() +
  # geom_hline(yintercept = 0) +
  # theme_bw() + 
  # ylab("Res√≠duos estudentizados") + 
  # xlab("Variedade")


```

Aparentemente, as dispers√µes dos res√≠duos por tratamento s√£o semelhantes.

```{r}
# levene.test(rstandard(modelotransformado), dadospessego$Variedadepessego, location = "mean")
```

Como o valor-p = 0,9258 > 0,05 = Œ±, considerando-se o n√≠vel de 5% de signific√¢ncia, n√£o rejeitamos H0. Logo, h√° evid√™ncias para afirmarmos que h√° homogeneidade de vari√¢ncias dos erros.


```{r}
# ggplot(dadospessego,
#        aes(x = fitted(modelotransformado),
#            y = rstandard(modelotransformado))) + 
#   geom_point() +
#   geom_hline(yintercept = 0) +
#   theme_bw () + 
#   ylab("Res√≠duos Estudentizados") + 
#   xlab(" Valores esperados (m√©dias0")
```


Agora, aparentemente, h√° um leve aumento na dispers√£o dos res√≠duos conforme o valor predito aumenta.

```{r}
# boxcox(modelotransformado, ylab="logaritmo da verossimilhan√ßa")
```


Quando utilizados os dados transformados, verifica-se que o valor 1 pertence ao intervalo de confian√ßa para Œª. Desse modo, nova transforma√ß√£o n√£o √© indicada.

Atendidas as pressuposi√µes para a realiza√ß√£o da an√°lise de vari√¢ncia, considerando-se os dados transformados, temos:

```{r}
# anova(modelotransformado)
```

Como o valor-p = 4, 623 √ó 10‚àí9 < 0, 05 = Œ±, considerando o n√≠vel de 5% de signific√¢ncia, rejeitamos H0. Desse modo, h√° evid√™ncias para afirmarmos que pelo menos um contraste de m√©dias difere de zero.

```{r}
# library(ExpDes.pt)
# with(dadospessego,
#      dic(Variedadepessego,
#          estacasenraizadast))

```

Grupos| Tratamentos| M√©dias|
-|-|-|
a|C|3,63|
a|D|3,18|
b|A|1,26|
b|B|1,01|

A partir do teste de Tukey, ao n√≠vel de 5% de signific√¢ncia, h√° evid√™ncias para afirmarmos que as m√©dias para as variedades C e D diferem das m√©dias paras as variedades A e B, e as demais m√©dias n√£o diferem entre si.





Fa√ßa o upload da resolu√ß√£o e tire suas [aqui](https://forms.gle/LQ6mNE4DoR1Fk6px6)
